@model CourseProject.Models.CourseContentViewModels.Test.TestStatsViewModel
@{
    ViewData["Title"] = $"Результаты: {Model.TestTitle}";
}

<div class="mb-3">
    <a asp-action="ManageTests" asp-route-subjectId="@Model.SubjectId" class="text-decoration-none text-muted small">
        <i class="bi bi-arrow-left"></i> Назад к тестам
    </a>
</div>

<h2>Результаты теста: @Model.TestTitle</h2>

<div class="d-flex justify-content-between align-items-center mb-3 mt-3">
    
    <div class="text-muted">
        Всего студентов: @Model.Results.Count
    </div>

    <div class="d-flex">
        <input type="text" id="statsSearchInput" class="form-control me-2" 
               placeholder="Поиск студента..." style="width: 250px;" onkeyup="filterStats()" />
        
        <button type="button" class="btn btn-outline-primary" onclick="filterStats()">Поиск</button>
        <button type="button" class="btn btn-outline-secondary ms-1" onclick="resetSearch()">Сброс</button>
    </div>
</div>

<table class="table align-middle table-bordered" id="statsTable">
    <thead class="table-light">
    <tr>
        <th class="text-start">Студент</th>
        <th class="text-center" style="width: 150px;">Группа</th>
        <th class="text-center" style="width: 120px;">Попыток</th>
        <th class="text-center" style="width: 150px;">Лучший балл</th>
        <th class="text-end" style="width: 200px;">Дата сдачи</th>
    </tr>
    </thead>
    <tbody>
    @if (Model.Results.Any())
    {
        foreach (var item in Model.Results)
        {
            <tr class="stats-row">
                <td class="text-start">
                    @item.StudentName
                </td>

                <td class="text-center">
                    @(string.IsNullOrEmpty(item.GroupName) ? "—" : item.GroupName)
                </td>

                <td class="text-center">
                    @item.AttemptsCount
                </td>

                <td class="text-center">
                    @if (item.BestScore.HasValue)
                    {
                        <span class="badge bg-success bg-opacity-10 text-success border border-success border-opacity-25 fs-6">
                            @item.BestScore.Value
                        </span>
                    }
                    else
                    {
                        <span class="text-muted small">—</span>
                    }
                </td>

                <td class="text-end text-muted small">
                    @(item.LastAttemptDate?.ToString("dd.MM.yyyy HH:mm") ?? "—")
                </td>
            </tr>
        }
    }
    else
    {
        <tr>
            <td colspan="5" class="text-center py-5 text-muted">
                <p class="mb-0">Пока никто не проходил этот тест.</p>
            </td>
        </tr>
    }
    </tbody>
</table>

<div id="noStatsFound" class="text-center py-4 text-muted" style="display: none;">
    По вашему запросу ничего не найдено.
</div>

<script>
    function filterStats() {
        const input = document.getElementById("statsSearchInput");
        const filter = input.value.toLowerCase();
        const table = document.getElementById("statsTable");
        const rows = table.getElementsByClassName("stats-row");
        let hasVisible = false;

        for (let i = 0; i < rows.length; i++) {
            const nameCell = rows[i].getElementsByTagName("td")[0];
            const groupCell = rows[i].getElementsByTagName("td")[1];
            
            if (nameCell && groupCell) {
                const nameText = nameCell.textContent || nameCell.innerText;
                const groupText = groupCell.textContent || groupCell.innerText;
                
                if (nameText.toLowerCase().indexOf(filter) > -1 || groupText.toLowerCase().indexOf(filter) > -1) {
                    rows[i].style.display = "";
                    hasVisible = true;
                } else {
                    rows[i].style.display = "none";
                }
            }
        }

        const noDataMsg = document.getElementById("noStatsFound");
        if (noDataMsg) {
            noDataMsg.style.display = hasVisible ? "none" : "block";
        }
    }

    function resetSearch() {
        const input = document.getElementById("statsSearchInput");
        input.value = "";
        filterStats();
    }
</script>