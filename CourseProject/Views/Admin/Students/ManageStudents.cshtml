@model CourseProject.Models.AdminViewModels.Student.ManageStudentsViewModel
@{
    ViewData["Title"] = "Студенты";
}

<div class="container py-4">
    <div class="mb-4">
        <a asp-controller="Admin" asp-action="Index" class="text-decoration-none text-muted">
            <i class="bi bi-arrow-left"></i> Назад в панель администратора
        </a>
        <h2 class="fw-bold mt-2">Управление студентами</h2>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3 mt-3">
        <a asp-action="CreateStudent" class="btn btn-success">
            <i class="bi bi-plus-lg"></i> Добавить студента
        </a>

        <form asp-action="ManageStudents" method="get" class="d-flex">
            <input type="text" name="searchString" value="@ViewData["SearchString"]" class="form-control me-2" placeholder="Поиск студента..." style="width: 250px;" />
            <button type="submit" class="btn btn-outline-primary">Поиск</button>
            <a asp-action="ManageStudents" class="btn btn-outline-secondary ms-1">Сброс</a>
        </form>
    </div>

    <table class="table table-hover align-middle table-bordered">
        <thead class="table-light">
        <tr>
            <th class="text-start">ФИО</th>
            <th class="text-center">Email</th>
            <th class="text-center">Описание</th>
            <th class="text-center">Группа</th>
            <th class="text-end" style="width: 150px;">Действия</th> </tr>
        </thead>
        <tbody>
        @foreach (var student in Model.Students)
        {
        <tr>
            <td class="text-start">@student.FullName</td>
            <td class="text-center">@student.Email</td>
            <td class="text-center">@student.Description</td>

            <td class="text-center">
                <div class="dropdown d-inline-block">
                    <button class="btn btn-outline-secondary dropdown-toggle btn-sm" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="min-width: 140px;">
                        @(student.Group != null ? student.Group.GroupName : "Нет группы")
                    </button>

                    <div class="dropdown-menu p-3 shadow text-start" style="width: 300px;" onclick="event.stopPropagation()">
                        <form asp-action="UpdateStudentGroup" method="post">
                            <input type="hidden" name="studentId" value="@student.Id" />

                            <h6 class="dropdown-header px-0">Выберите группу:</h6>
                            <input type="text" class="form-control form-control-sm mb-2 group-search-input" placeholder="Поиск группы..." onkeyup="filterGroups(this)">

                            <div class="group-list-container" style="max-height: 200px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 4px; padding: 5px;">
                                <div class="form-check group-item">
                                    <input class="form-check-input" type="radio" name="selectedGroupId" value="" id="grp_none_@student.Id" @(student.GroupId == null ? "checked" : "")>
                                    <label class="form-check-label small text-danger" for="grp_none_@student.Id"><i>Без группы</i></label>
                                </div>
                                <hr class="my-1">
                                @foreach (var group in Model.AllGroups)
                                {
                                <div class="form-check group-item">
                                    <input class="form-check-input" type="radio" name="selectedGroupId" value="@group.Id" id="grp_@student.Id@group.Id" @(student.GroupId == group.Id ? "checked" : "")>
                                    <label class="form-check-label small" for="grp_@student.Id@group.Id">@group.GroupName</label>
                                </div>
                                }
                                <div class="text-muted small text-center no-results" style="display:none;">Нет совпадений</div>
                            </div>

                            <div class="d-flex justify-content-end align-items-center mt-2 border-top pt-2">
                                <button type="submit" class="btn btn-primary btn-sm w-100">Сохранить</button>
                            </div>
                        </form>
                    </div>
                </div>
            </td>

            <td class="text-end text-nowrap">
                <a asp-action="EditStudent" asp-route-id="@student.Id" class="btn btn-sm btn-warning me-1" title="Редактировать">
                    <i class="bi bi-pencil"></i>
                </a>
                <form asp-action="DeleteUser" asp-route-id="@student.Id" method="post" class="d-inline" onsubmit="return confirm('Удалить студента?');">
                    <button type="submit" class="btn btn-sm btn-danger" title="Удалить">
                        <i class="bi bi-trash"></i>
                    </button>
                </form>
            </td>
        </tr>
        }
        </tbody>
    </table>
</div>

<script>
    function filterGroups(inputElement) {
        const searchTerms = inputElement.value.toLowerCase().split(" ").filter(t => t.length > 0);
        const container = inputElement.closest('form').querySelector('.group-list-container');
        const items = container.querySelectorAll('.group-item');
        let hasVisibleItems = false;
        items.forEach(item => {
            const label = item.querySelector('label').innerText.toLowerCase();
            const isMatch = searchTerms.every(term => label.includes(term));
            if (isMatch || item.querySelector('input').value === "") { item.style.display = ""; hasVisibleItems = true; } 
            else { item.style.display = "none"; }
        });
        const noResultsMsg = container.querySelector('.no-results');
        if (noResultsMsg) { noResultsMsg.style.display = hasVisibleItems ? "none" : "block"; }
    }
</script>