@model CourseProject.Models.CourseContentViewModels.Test.TakeTestViewModel
@{ ViewData["Title"] = "Тестирование"; }

<div class="container mt-4">
    <div class="sticky-top bg-white border-bottom py-3 mb-4 shadow-sm">
        <div class="d-flex justify-content-between align-items-center">
            <h4 class="m-0">@Model.Title</h4>
            @if(Model.TimeLimitMinutes > 0)
            {
                <div class="text-danger fw-bold fs-5">
                    <i class="bi bi-stopwatch"></i> <span id="timeRemaining">--:--</span>
                </div>
            }
        </div>
    </div>

    <form asp-action="SubmitTest" method="post" id="testForm">
        <input type="hidden" name="TestAttemptId" value="@Model.TestAttemptId" />

        @for (int i = 0; i < Model.Questions.Count; i++)
        {
            var q = Model.Questions[i];
            <div class="card mb-4 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Вопрос @(i + 1) <small class="text-muted">(@q.Points баллов)</small></h5>
                    <p class="card-text fs-5">@q.Text</p>
                    
                    <input type="hidden" name="Answers[@i].QuestionId" value="@q.QuestionId" />

                    <div class="mt-3">
                        @foreach (var opt in q.Options)
                        {
                            <div class="form-check mb-2">
                                @if (q.Type == "Single")
                                {
                                    <input class="form-check-input" type="radio" 
                                           name="Answers[@i].SelectedOptionIds" 
                                           value="@opt.Id" 
                                           id="opt_@opt.Id">
                                }
                                else
                                {
                                    <input class="form-check-input" type="checkbox" 
                                           name="Answers[@i].SelectedOptionIds" 
                                           value="@opt.Id" 
                                           id="opt_@opt.Id">
                                }
                                <label class="form-check-label" for="opt_@opt.Id">@opt.Text</label>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        <div class="d-grid gap-2 mb-5">
            <button type="submit" class="btn btn-primary btn-lg" onclick="return confirm('Завершить тест?');">
                Завершить и отправить
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        const limitMinutes = @Model.TimeLimitMinutes;
        if (limitMinutes > 0) {
            const startTimeStr = '@Model.StartTime.ToString("yyyy-MM-ddTHH:mm:ss")'; 
            const startTime = new Date(startTimeStr);
            const endTime = new Date(startTime.getTime() + limitMinutes * 60000);
            
            const timerElement = document.getElementById('timeRemaining');
            const form = document.getElementById('testForm');

            function updateTimer() {
                const now = new Date();
                const diff = endTime - now;

                if (diff <= 0) {
                    timerElement.innerText = "00:00";
                    alert("Время вышло! Тест отправляется.");
                    form.submit();
                    return;
                }

                const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                timerElement.innerText = (minutes < 10 ? "0" : "") + minutes + ":" + (seconds < 10 ? "0" : "") + seconds;
            }
            setInterval(updateTimer, 1000);
            updateTimer();
        }
    </script>
}